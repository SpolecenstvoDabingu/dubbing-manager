{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load has_permition %}

{% block content %}
<div class="table-responsive mb-2">
  <table class="table table-striped table-hover text-white">
    <thead>
      <tr>
        <th class="col-2 text-center">{% trans "frontend.users.username" context "Username title" %}</th>
        <th class="col-6 text-center">{% trans "frontend.users.roles" context "Roles title" %}</th>
        <th class="col-1 text-center">{% trans "frontend.users.is_member" context "Is member title" %}</th>
        <th class="col-1 text-center">{% trans "frontend.users.super_user" context "Super user title" %}</th>
        <th class="col-1 text-center">{% trans "frontend.users.actions" context "Actions title" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td class="text-center align-middle">
          <div style="position: relative; width: 120px; height: 120px; overflow: hidden; display: inline-block; border-radius: 0.25rem; box-shadow: 0 0 4px rgba(0,0,0,0.3);" class="align-middle">
            <img 
                src="{{ user.discord_get_avatar }}" 
                alt="{{ user.discord_display_name }}" 
                style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                data-toggle="modal" 
                data-target="#imageModal" 
                data-img-url="{{ user.discord_get_avatar }}"
                data-img-alt="{{ user.discord_display_name }}"
            >
            <span
                style="
                    position: absolute;
                    right: 4px;
                    bottom: 4px;
                    background: rgba(0,0,0,0.7);
                    color: #fff;
                    font-size: 1rem;
                    padding: 2px 8px;
                    border-radius: 0.2rem;
                    max-width: 95%;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                "
                class="{% if user.is_superuser %}text-orange{% elif user.is_staff %}text-yellow{% else %}text-white{% endif %}"
                title="{{ user.discord_display_name }}"
            >
                {{ user.discord_display_name }}
            </span>
          </div>
        </td>
        <td class="text-center align-middle">
          {% for perm, label in role_choices %}
            {% with "database."|add:perm as full_perm %}
              {% if user|has_permition:full_perm %}
                <span class="badge badge-success">{{ label }}</span>
              {% endif %}
            {% endwith %}
          {% endfor %}
        </td>
        <td class="text-center align-middle">{% if user.discord_is_member %}<i class="fa fa-check"></i>{% else %}<i class="fa fa-times"></i>{% endif %}</td>
        <td class="text-center align-middle">{% if user.is_superuser %}<i class="fa fa-check"></i>{% else %}<i class="fa fa-times"></i>{% endif %}</td>
        <td class="text-center align-middle">
          <button class="btn btn-warning w-100"
                  data-toggle="modal"
                  data-target="#ModifyModal"
                  data-modal-title="{% trans 'frontend.users.edit_title' context 'Modal title for editing' %}"
                  data-action-url="{% url 'update_user' user.id %}"
                  data-redirect-url="{% url 'manage_users' %}"
                  data-fields='[
                    {
                      "label": "{% trans "frontend.users.username" context "Username title" %}",
                      "type": "text",
                      "name": "username",
                      "value": "{{ user.username|escape }}",
                      "required": true
                    },
                    {
                      "label": "{% trans "frontend.users.email" context "Email title" %}",
                      "type": "email",
                      "name": "email",
                      "value": "{{ user.email|escape }}"
                    },
                    {
                      "label": "{% trans "frontend.users.roles" context "Roles title" %}",
                      "type": "select",
                      "name": "role",
                      "multiple": true,
                      "value": [
                        {% for perm, _ in role_choices %}
                          {% with "database."|add:perm as full_perm %}
                            {% if user|has_permition:full_perm %}
                              "{{ perm|escape }}"{% if not forloop.last %},{% endif %}
                            {% endif %}
                          {% endwith %}
                        {% endfor %}
                      ],
                      "options": [
                        {% for perm, label in role_choices %}
                          { "value": "{{ perm|escape }}", "label": "{{ label|escape }}" }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                      ]
                    }
                  ]'>
            {% trans "frontend.users.edit" context "Edit button title" %}
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% include "components/image_modal.html" %}
{% include "components/modify_modal.html" %}
{% endblock %}
